# Pinecone Vector Database Architecture

## Overview

All clients share a single Pinecone index: `marketing-automation`

Clients are isolated via namespaces with the pattern: `{namespace-type}-{brand-id}`

**Purpose:** Semantic memory for intelligent content matching, scenario retrieval, and cross-campaign learning.

## Why Pinecone?

- **Semantic search:** Find similar content, scenarios, audiences by meaning, not exact match
- **Fast retrieval:** Sub-second queries even with millions of vectors
- **Namespace isolation:** Single index, logically separated clients
- **Metadata filtering:** Combine semantic similarity with structured filters
- **Cost-efficient:** One-time embedding, infinite queries

## Index Configuration

```
Index Name: marketing-automation
Dimensions: 1536 (OpenAI text-embedding-3-small or Claude embed)
Metric: cosine
Cloud: AWS or GCP
Region: us-east-1 (or closest to your deployment)
Pod Type: p1.x1 (starter) or p2.x1 (production)
```

## Namespace Structure

### Pattern: `{type}-{brand-id}`

Example for client "zen-med-clinic":
- `content-essence-zen-med-clinic`
- `scenario-outcomes-zen-med-clinic`
- `audience-psychographics-zen-med-clinic`
- `narrative-patterns-zen-med-clinic`

Plus one shared namespace (no brand-id):
- `cross-campaign-learnings`

---

## Namespace 1: content-essence-{brand-id}

### Purpose
Semantic profiles of all creative assets (videos, images).

### What's Embedded
Rich narrative description of the content generated by Claude Vision API.

### Example Embedding Source
```
A 30-second vertical video showcasing a peaceful acupuncture treatment session. 
Visual aesthetic is minimal and intimate with warm, soft lighting creating a calm 
atmosphere. Color palette features earth tones, beiges, and warm browns. Camera 
work is steady and close, focusing on the serene treatment environment. The space 
is modern yet inviting with clean lines. Through the window, the Stanford campus 
is visible, establishing local context. No dialogue, just ambient peaceful sounds. 
Pacing is slow and meditative. Shows the physical clinic interior, establishing 
place. Production quality is professional with high resolution. The emotional tone 
is calming, reassuring, and professional. This content communicates expertise, 
tranquility, and local presence. Suitable for awareness-building among local 
audiences who value wellness and stress relief.
```

### Vector Metadata Structure

```json
{
  "id": "content_video-003_zen-med-clinic",
  "values": [0.234, -0.891, 0.445, ...],
  "metadata": {
    // Identity
    "content_id": "video-003",
    "brand_id": "zen-med-clinic",
    "industry": "chinese-medicine",
    "drive_id": "abc123xyz",
    "drive_url": "https://drive.google.com/file/d/abc123xyz",
    "filename": "acupuncture-treatment-calm.mp4",
    
    // Profile Attributes
    "emotional_tones": ["calm", "reassuring", "professional"],
    "tone_confidences": [0.95, 0.88, 0.82],
    "visual_aesthetics": ["minimal", "intimate", "modern"],
    "aesthetic_confidences": [0.92, 0.85, 0.78],
    "color_palette_primary": ["warm-tones", "earth-tones", "beige"],
    "color_palette_accent": ["soft-brown", "cream"],
    "color_temperature": "warm",
    "composition_types": ["close-up", "medium-shot"],
    "camera_movement": "steady",
    "pacing": "slow",
    
    // Narrative Elements (boolean flags)
    "shows_physical_space": true,
    "shows_people": false,
    "shows_product_service": true,
    "local_landmark_visible": "stanford-campus",
    "has_dialogue": false,
    "has_text_overlay": false,
    
    // Technical
    "duration_seconds": 30,
    "resolution": "1080x1920",
    "format": "vertical-video",
    "production_quality": "professional-high",
    
    // Performance (updated over time via index.update())
    "total_impressions": 45000,
    "total_spend": 1250.50,
    "avg_ctr": 0.039,
    "avg_cpm": 8.50,
    "avg_roas": 4.1,
    "best_performing_demographic": "wellness-focused-women-35-50",
    "best_performing_platform": "instagram",
    "best_performing_time": "weekday-evening",
    "creative_fatigue_score": 0.2,
    "last_used_date": "2026-01-28",
    
    // Temporal
    "upload_date": "2026-01-15",
    "profile_date": "2026-01-15"
  }
}
```

### Use Cases

**1. Find Similar Content**
```python
# User wants content similar to top-performing video-003
query_vector = get_vector_by_id("content_video-003_zen-med-clinic")

results = index.query(
    namespace="content-essence-zen-med-clinic",
    vector=query_vector,
    top_k=10,
    include_metadata=True
)
# Returns: 10 most similar content pieces
```

**2. Find Fresh Content with Specific Aesthetic**
```python
# Find unused "calm + minimal" content
query_text = "calm minimal peaceful treatment environment warm tones"
query_vector = embed(query_text)

results = index.query(
    namespace="content-essence-zen-med-clinic",
    vector=query_vector,
    top_k=5,
    include_metadata=True,
    filter={
        "total_impressions": {"$lt": 5000},  # Fresh/unused
        "emotional_tones": {"$in": ["calm"]},
        "visual_aesthetics": {"$in": ["minimal"]}
    }
)
# Returns: Fresh content matching the vibe
```

**3. Portfolio Balance Analysis**
```python
# Get all content, cluster by semantic similarity
all_content = index.query(
    namespace="content-essence-zen-med-clinic",
    vector=[0]*1536,  # Dummy vector
    top_k=1000,
    include_metadata=True
)

# Cluster vectors to identify content gaps
# If all content clusters around "calm minimal", need "energetic vibrant"
```

### Metadata Update Pattern

Performance metadata is updated after each campaign day:

```python
# n8n workflow: Daily Performance Analysis
# After aggregating yesterday's performance for video-003

index.update(
    id="content_video-003_zen-med-clinic",
    set_metadata={
        "total_impressions": 45000,  # Incremented
        "total_spend": 1250.50,      # Incremented
        "avg_roas": 4.1,             # Recalculated
        "avg_ctr": 0.039,            # Recalculated
        "creative_fatigue_score": 0.2,  # Calculated
        "last_used_date": "2026-01-28"
    },
    namespace="content-essence-zen-med-clinic"
)
```

**Note:** Vector values never change (content doesn't change), only metadata.

---

## Namespace 2: scenario-outcomes-{brand-id}

### Purpose
Learn from past campaign scenarios to inform future decisions.

### What's Embedded
Full context description combining: content profile + audience + platform + timing + geographic targeting + outcome.

### Example Embedding Source
```
Scenario: Running a 30-second video with calm, reassuring tone and minimal 
aesthetic featuring warm earth tones. Video shows peaceful acupuncture treatment 
in modern clinic space with Stanford campus visible through windows. Content 
demonstrates service in intimate, professional manner with slow pacing and ambient 
audio only. Targeting wellness-focused professional women aged 35-50 within 10-15 
mile radius of Palo Alto location. Running on Instagram during weekday evenings 
(6-9pm) with $45/day budget. Campaign goal is local awareness building for people 
who may not know clinic exists. User journey stage: awareness. Season: Winter. 
Day: Wednesday.

Outcome: Achieved 4.2 ROAS with 0.042 CTR, $8.50 CPM, 31% conversion rate. Strong 
performance in outer radius (10-15mi) as predicted. Content resonated particularly 
well with target demographic. Local landmark visibility correlated with 20% higher 
engagement than similar content without location context.
```

### Vector Metadata Structure

```json
{
  "id": "scenario_20260115_001_zen-med-clinic",
  "values": [0.123, 0.567, -0.234, ...],
  "metadata": {
    // Scenario Identity
    "scenario_id": "scenario_20260115_001",
    "brand_id": "zen-med-clinic",
    "industry": "chinese-medicine",
    
    // Campaign Parameters
    "content_id": "video-003",
    "platform": "instagram",
    "demographic_target": "wellness-focused-women-35-50",
    "geographic_target": "10-15mi-radius",
    "time_slot": "weekday-evening",
    "budget_per_day": 45.00,
    "campaign_goal": "local-awareness",
    "journey_stage": "awareness",
    
    // Content Characteristics (copied from content profile for filtering)
    "content_tones": ["calm", "reassuring", "professional"],
    "content_aesthetics": ["minimal", "intimate", "modern"],
    "content_colors": ["warm-tones", "earth-tones"],
    "shows_location": true,
    "local_landmark": "stanford-campus",
    
    // Performance Outcomes
    "roas": 4.2,
    "ctr": 0.042,
    "conversion_rate": 0.31,
    "cpm": 8.50,
    "cpc": 0.45,
    "cost_per_conversion": 14.52,
    "total_impressions": 12500,
    "total_spend": 315.00,
    "total_conversions": 22,
    
    // Insights/Learnings
    "key_insight": "local-landmark-visibility-boosts-engagement",
    "surprise_factor": 0.15,  // 15% above prediction
    "confidence_score": 0.92,
    
    // Temporal/Contextual
    "date": "2026-01-15",
    "day_of_week": "wednesday",
    "season": "winter",
    "campaign_age_days": 12
  }
}
```

### Use Cases

**1. Decision Support - "What happened in similar situations?"**
```python
# CSO Agent deciding whether to shift budget from Facebook to Instagram

situation = """
Considering shifting $150/day from Facebook (2.1 ROAS) to Instagram (4.2 ROAS) 
for wellness-focused women 35-50 demographic. Both platforms running same calm 
minimal content showing treatment space. Instagram CPM higher but ROAS much better.
"""

situation_vector = embed(situation)

similar_scenarios = index.query(
    namespace="scenario-outcomes-zen-med-clinic",
    vector=situation_vector,
    top_k=10,
    include_metadata=True,
    filter={
        "platform": {"$in": ["facebook", "instagram"]},
        "demographic_target": "wellness-focused-women-35-50"
    }
)

# Analyze outcomes: What happened when others made similar shifts?
roas_deltas = [s.metadata['roas'] for s in similar_scenarios]
avg_outcome = mean(roas_deltas)
# Inform decision with historical data
```

**2. Performance Prediction**
```python
# Predict performance for new content + audience combination

new_scenario = """
Planning to run new energetic video with vibrant colors showing team interactions.
Targeting younger professionals 25-35 on Instagram during morning hours (7-10am).
$60/day budget. Campaign goal: awareness and engagement.
"""

new_scenario_vector = embed(new_scenario)

similar_past_scenarios = index.query(
    namespace="scenario-outcomes-zen-med-clinic",
    vector=new_scenario_vector,
    top_k=15,
    include_metadata=True,
    filter={
        "content_tones": {"$in": ["energetic"]},
        "platform": "instagram"
    }
)

# Calculate predicted ROAS from similar scenarios
predicted_roas = mean([s.metadata['roas'] for s in similar_past_scenarios])
confidence = len(similar_past_scenarios) / 15  # More matches = higher confidence
```

**3. Hypothesis Validation**
```python
# Does showing physical location actually boost performance?

location_scenarios = index.query(
    namespace="scenario-outcomes-zen-med-clinic",
    vector=[0]*1536,  # Get all
    top_k=1000,
    include_metadata=True,
    filter={"shows_location": true}
)

no_location_scenarios = index.query(
    namespace="scenario-outcomes-zen-med-clinic",
    vector=[0]*1536,
    top_k=1000,
    include_metadata=True,
    filter={"shows_location": false}
)

avg_roas_with_location = mean([s.metadata['roas'] for s in location_scenarios])
avg_roas_without = mean([s.metadata['roas'] for s in no_location_scenarios])

# Statistical validation of hypothesis
```

---

## Namespace 3: audience-psychographics-{brand-id}

### Purpose
Deep understanding of who audiences are beyond demographics.

### What's Embedded
Rich psychographic profile synthesized from observed behaviors and preferences.

### Example Embedding Source
```
Wellness-focused professional women aged 35-50 in Palo Alto area demonstrate 
strong affinity for calm, reassuring content with minimal aesthetics and warm 
color palettes. They engage heavily during weekday evenings (6-9pm), suggesting 
stress-relief seeking behavior after work hours. This demographic responds to 
narratives of self-care, expertise, and local trust-building. They value 
professional quality and authenticity over flashy marketing. Content showing 
physical spaces and establishing local presence performs 20% better than purely 
service-focused content. They prefer slow-paced, meditative content over fast, 
energetic styles. Key motivations include: stress relief, preventive health, 
holistic wellness, work-life balance. Decision-making factors: proximity to 
location, professional credentials visible, calm atmosphere, modern facilities. 
Price sensitivity: moderate-low (values quality over cost). Conversion journey: 
longer consideration phase (7-14 days), multiple touchpoints needed. Social proof 
important but not decisive. Responds well to educational content. Skeptical of 
discounts (sees as quality signal). High lifetime value once converted.
```

### Vector Metadata Structure

```json
{
  "id": "audience_wellness-women-35-50_zen-med-clinic",
  "values": [0.456, -0.123, 0.789, ...],
  "metadata": {
    // Identity
    "demographic_name": "wellness-focused-women-35-50",
    "brand_id": "zen-med-clinic",
    "industry": "chinese-medicine",
    
    // Basic Demographics
    "age_min": 35,
    "age_max": 50,
    "gender": "female",
    "income_level": "middle-to-upper",
    
    // Behavioral Patterns
    "peak_engagement_times": ["weekday-evening"],
    "avg_consideration_days": 10.5,
    "touchpoints_needed": 4,
    "price_sensitivity": "moderate-low",
    
    // Content Preferences
    "preferred_tones": ["calm", "professional", "reassuring"],
    "preferred_aesthetics": ["minimal", "intimate", "warm"],
    "preferred_pacing": "slow",
    "responds_to_location": true,
    
    // Performance Metrics
    "avg_ctr": 0.041,
    "avg_roas": 3.9,
    "conversion_rate": 0.28,
    "sample_size": 145,  // Number of campaigns targeting this demo
    
    // Insights
    "key_motivations": ["stress-relief", "preventive-health", "work-life-balance"],
    "decision_factors": ["proximity", "credentials", "atmosphere"],
    "avoid": ["discount-messaging", "fear-based", "high-energy"],
    
    // Temporal
    "profile_created": "2026-01-15",
    "last_updated": "2026-02-01"
  }
}
```

### Use Cases

**1. Understand "Why" Behind Performance**
```python
# Cultural Anthropologist Agent analyzing unexpected performance

demographic = "wellness-focused-women-35-50"

psychographic = index.query(
    namespace="audience-psychographics-zen-med-clinic",
    vector=embed(demographic),
    top_k=1,
    include_metadata=True
)

profile = psychographic.matches[0].metadata
# Use profile to explain: "They engage evenings because stress-relief seeking..."
```

**2. Identify Expansion Opportunities**
```python
# Find similar demographics that might respond to same content

current_demo = "wellness-focused-women-35-50"
current_vector = get_vector_by_id(f"audience_{current_demo}_zen-med-clinic")

similar_audiences = index.query(
    namespace="audience-psychographics-zen-med-clinic",
    vector=current_vector,
    top_k=5,
    include_metadata=True,
    filter={
        "demographic_name": {"$ne": current_demo}  // Exclude current
    }
)

# Suggest expansion: "stressed-professionals-25-40" shares preferences
```

---

## Namespace 4: narrative-patterns-{brand-id}

### Purpose
Understanding which story structures and messaging themes resonate.

### What's Embedded
Description of narrative arc, messaging approach, and its effectiveness.

### Example Embedding Source
```
Narrative Pattern: "Trust Through Place Establishment"

Story structure: Opens with exterior establishing shot showing recognizable local 
landmark (Stanford campus). Transitions to interior spaces (treatment rooms, 
reception). Focuses on environment rather than people. No explicit sales message. 
Lets viewer imagine themselves in the space. Closes with subtle location/contact 
info. 

Emotional arc: Curiosity (where is this?) → Recognition (I know that place!) → 
Comfort (it looks peaceful) → Trust (professional, established, accessible).

Messaging approach: Show don't tell. Location = legitimacy. Calm environment = 
service quality. No hard sell.

Performance: This narrative pattern performs 22% better than service-demonstration 
content for local awareness campaigns within 15-mile radius. Particularly effective 
for first-time awareness (users who don't know brand exists). Works across wellness 
industries (acupuncture, massage, yoga, med spas). Effectiveness increases with 
viewer proximity to location.
```

### Use Cases

**1. Guide Creative Strategy**
```python
# Creative Director Agent requesting new content

successful_narratives = index.query(
    namespace="narrative-patterns-zen-med-clinic",
    vector=embed("local awareness trust building"),
    top_k=5,
    include_metadata=True,
    filter={
        "performance_tier": "high"  // ROAS > 3.5
    }
)

# Identify patterns: "Trust through place establishment" works
# Request new content following this pattern
```

---

## Namespace 5: cross-campaign-learnings (Shared - No brand_id)

### Purpose
Meta-insights that apply across multiple clients and industries.

### What's Embedded
Anonymized patterns discovered across all clients.

### Example Embedding Source
```
Cross-Campaign Pattern: "Local Landmark Lift Effect"

Finding: Service businesses showing physical location with visible local landmarks 
consistently outperform location-free content by 15-25% for local awareness 
campaigns within 15-mile radius. Effectiveness increases with proximity tier:
- 5-10mi: +25% engagement
- 10-15mi: +40% engagement

This pattern holds across:
- Wellness services (acupuncture, massage, yoga, med spas)
- Personal services (hair salons, barbershops, spas)
- Professional services (dental, chiropractic, physical therapy)

Likely mechanism: Trust-building through place establishment. Reduces perceived 
barrier to visit ("I drive past that every day"). Creates familiarity before first 
contact.

Most effective when combined with:
- Calm, professional tone (not energetic/sales-y)
- Minimal aesthetic (not cluttered)
- Slow pacing (not rushed)

Sample size: 47 campaigns across 12 businesses
Confidence: 0.94
Discovered: 2026-01-20
```

### Vector Metadata Structure

```json
{
  "id": "cross_local-landmark-lift_001",
  "values": [0.234, 0.567, -0.123, ...],
  "metadata": {
    // Identity
    "insight_id": "local-landmark-lift",
    "pattern_type": "content-strategy",
    
    // Applicability
    "industries": ["wellness", "personal-services", "professional-services"],
    "business_models": ["brick-and-mortar-primary"],
    "campaign_goals": ["local-awareness"],
    
    // Performance
    "avg_performance_lift": 0.22,  // 22% improvement
    "sample_size": 47,
    "confidence": 0.94,
    
    // Context
    "effective_with": ["calm-tone", "minimal-aesthetic", "slow-pacing"],
    "not_effective_with": ["discount-messaging", "high-energy"],
    
    // Temporal
    "discovered_date": "2026-01-20",
    "last_validated": "2026-02-01",
    "validation_count": 12
  }
}
```

### Use Cases

**1. Inform New Client Strategy**
```python
# Strategist Agent working on first spawn for new wellness client

industry = "chinese-medicine"
business_model = "brick-and-mortar-primary"

relevant_insights = index.query(
    namespace="cross-campaign-learnings",
    vector=embed(f"{industry} local awareness content strategy"),
    top_k=10,
    include_metadata=True,
    filter={
        "industries": {"$in": [industry, "wellness"]},
        "business_models": {"$in": [business_model]}
    }
)

# Apply learned patterns: "Show location with landmark" strategy
```

---

## Embedding Strategy

### Which Embedding Model?

**Option 1: OpenAI text-embedding-3-small** (Recommended)
- Dimensions: 1536
- Cost: $0.02 / 1M tokens
- Quality: Excellent for marketing content
- Speed: Very fast

**Option 2: Claude Embed** (Future - when available)
- Native Anthropic embeddings
- Same model family as analysis
- May have better semantic understanding of Claude-generated descriptions

### Embedding Process

```python
# In n8n workflow: Content Ingestion

# Step 1: Claude Vision API analyzes content
content_analysis = claude_vision_api(image_file)

# Step 2: Generate rich semantic description
semantic_description = claude_api(
    prompt=f"Create a rich, detailed narrative description of this content for embedding: {content_analysis}"
)

# Step 3: Embed the description
embedding = openai.embeddings.create(
    model="text-embedding-3-small",
    input=semantic_description
)

# Step 4: Store in Pinecone
index.upsert(
    vectors=[{
        "id": f"content_{content_id}_{brand_id}",
        "values": embedding.data[0].embedding,
        "metadata": {
            # All metadata from content_analysis
        }
    }],
    namespace=f"content-essence-{brand_id}"
)
```

---

## Query Patterns

### Semantic Similarity Search
```python
# Find similar content
query_vector = embed("calm peaceful treatment environment")

results = index.query(
    namespace="content-essence-zen-med-clinic",
    vector=query_vector,
    top_k=10,
    include_metadata=True
)
```

### Filtered Semantic Search
```python
# Find similar content that's fresh and high-performing
results = index.query(
    namespace="content-essence-zen-med-clinic",
    vector=query_vector,
    top_k=10,
    include_metadata=True,
    filter={
        "$and": [
            {"total_impressions": {"$lt": 5000}},
            {"avg_roas": {"$gte": 3.5}},
            {"emotional_tones": {"$in": ["calm", "professional"]}}
        ]
    }
)
```

### Metadata-Only Query (No Vector)
```python
# Get all high-performing content (no semantic search)
results = index.query(
    namespace="content-essence-zen-med-clinic",
    vector=[0]*1536,  # Dummy vector
    top_k=100,
    include_metadata=True,
    filter={"avg_roas": {"$gte": 4.0}}
)
```

---

## Maintenance

### Updating Metadata
```python
# After daily performance run
index.update(
    id="content_video-003_zen-med-clinic",
    set_metadata={
        "total_impressions": new_total,
        "avg_roas": recalculated_roas,
        "last_used_date": "2026-02-01"
    },
    namespace="content-essence-zen-med-clinic"
)
```

### Deleting Vectors
```python
# Remove archived content
index.delete(
    ids=["content_video-old_zen-med-clinic"],
    namespace="content-essence-zen-med-clinic"
)
```

### Namespace Management
```python
# List all vectors in namespace (for backup/migration)
results = index.query(
    namespace="content-essence-zen-med-clinic",
    vector=[0]*1536,
    top_k=10000,
    include_metadata=True
)

# Namespaces are automatically created on first upsert
# No explicit creation needed
```

---

## Cost Estimation

**Pinecone Free Tier:**
- 100,000 vectors
- 1 pod
- Enough for ~20 clients with 5,000 content vectors each

**Pinecone Standard (p1.x1):**
- $70/month
- 5M vectors
- Enough for ~100 clients

**Embedding Costs (OpenAI):**
- ~$0.02 per 1M tokens
- Average content description: ~300 tokens
- Cost per content profile: $0.000006
- 1000 content profiles: $0.006 (negligible)

**Total Monthly Cost (20 clients):**
- Pinecone: Free tier
- Embeddings: ~$1
- **Total: ~$1/month**

---

## Security & Access

### API Key Management
```python
# Store in environment variables
PINECONE_API_KEY = os.getenv("PINECONE_API_KEY")
PINECONE_ENVIRONMENT = os.getenv("PINECONE_ENVIRONMENT")

# Initialize in n8n workflows
pinecone.init(
    api_key=PINECONE_API_KEY,
    environment=PINECONE_ENVIRONMENT
)
```

### Namespace Isolation
- Each client has separate namespaces
- No cross-client data leakage
- Brand_id in metadata for audit trail

---

## First Span Initialization

Database Schema Agent responsibilities on first spawn:

1. **Design namespace structure** (if not already documented)
2. **Create initialization code** for new client:
```python
# No explicit namespace creation needed in Pinecone
# Namespaces are created automatically on first upsert

# Just ensure naming convention
namespace_content = f"content-essence-{brand_id}"
namespace_scenarios = f"scenario-outcomes-{brand_id}"
namespace_psychographics = f"audience-psychographics-{brand_id}"
namespace_narratives = f"narrative-patterns-{brand_id}"

# Document in /marketing-factory/system-knowledge/database-schemas/
```

3. **Document schemas** in system-knowledge/
4. **Create query utilities** for runtime agents